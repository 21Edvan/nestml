/* 
BiexponentialSynapseResponse.nestml

Defines a postsynaptic response that is bi-exponential shaped, and shared between inhibitory and excitatory synapses. The postsynaptic shape is 

*/

neuron iaf_cond_beta:
  state:
    r integer             # counts number of tick during the refractory period
  end

  initial_values:
    V_m mV = E_L          # membrane potential
    g nS = 0 nS
    h nS/ms = 0 nS/ms
  end

  equations:
      g' = -g / tau_syn_decay + h
      h' = -h' / tau_syn_rise

       # shape g'' = -g' * (1/tau_r + 1/tau_d) - g / (tau_r * tau_d)
      
      inline I_syn_exc pA = (F_E + convolve(g, spikeExc)) * (V_m - E_ex)
      inline I_syn_inh pA = (F_I + convolve(g, spikeInh)) * (V_m - E_in)
      inline I_leak pA = g_L * (V_m - E_L)
      V_m' = (-I_leak - I_syn_exc - I_syn_inh + currents + I_e) / C_m
  end

  parameters:
    E_L mV = -85.0mV # Leak reversal Potential (aka resting potential)
    C_m pF = 250.0pF # Capacity of the membrane
    t_ref ms = 2.0ms # Refractory period
    V_th mV = -55.0mV      # Threshold Potential
    V_reset mV = -60.0mV   # Reset Potential
    E_ex mV = 0mV          # Excitatory reversal Potential
    E_in mV = -85.0mV      # Inhibitory reversal Potential
    g_L nS = 16.6667nS     # Leak Conductance
    tau_syn_rise_I ms = 0.2ms    # Synaptic Time Constant Excitatory Synapse
    tau_syn_decay_I ms = 2.0ms   # Synaptic Time Constant for Inhibitory Synapse
    tau_syn_rise_E ms = 0.2ms    # Synaptic Time Constant Excitatory Synapse
    tau_syn_decay_E ms = 2.0ms   # Synaptic Time Constant for Inhibitory Synapse
    I_e pA = 0pA            # Constant Current
    F_E nS = 0nS            # Constant External input conductance (excitatory).
    F_I nS = 0nS            # Constant External input conductance (inhibitory).
  end

  internals:
    # time of peak conductance excursion after spike arrival at t = 0
    t_peak real = tau_syn_decay * tau_syn_rise / (tau_syn_decay - tau_syn_rise) * ln(tau_syn_decay / tau_syn_rise)
  
    # normalisation constants to ensure arriving spike yields peak conductance of 1 nS
    g_const real = 1 / (exp(-t_peak / tau_syn_decay) - exp(-t_peak / tau_syn_rise))

    RefractoryCounts integer = steps(t_ref) # refractory time in steps
  end

  input:
      spikeInh nS  <- inhibitory spike
      spikeExc nS  <- excitatory spike
      currents <- current
  end

  output: spike

  update:

    integrate_odes()
    if r != 0: # not refractory
      r =  r - 1
      V_m = V_reset # clamp potential

    elif V_m >= V_th:
      r = RefractoryCounts
      V_m = V_reset # clamp potential
      emit_spike()

    end

    h_ex += spikeExc * g_E_const
    h_in += spikeInh * g_I_const
  end

end
